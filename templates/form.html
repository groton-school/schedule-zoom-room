<!DOCTYPE html>
<html>
    <head>
        <title>Zoom Room Scheduler</title>
    </head>
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 10pt;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            grid-template-rows: 1fr auto 1.618fr;
            height: 100vh;
        }

        #content {
            grid-row: 2;
            grid-column: 2;
        }

        p {
            max-width: 6in;
        }

        form {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1em;
        }

        .blocks-grid {
            display: grid;
            grid-template-columns: auto auto 1fr;
            gap: 0.5em;
        }

        .test {
            position: absolute;
            color: hsla(0, 0%, 0%, 0);
            white-space: nowrap;
        }

        .hidden {
            display: none;
        }
        </style>
    <body>
        <div id="content">
            <h1>Schedule Zoom Room</h1>
            <form id="form" action="<?= $_SERVER['PHP_SELF'] ?>" method="post">
                <label>Faculty Schedule URL</label>
                <input name="schedule_url" type="url" />

                <label>Start</label>
                <input name="start" type="date" />

                <label>End Extraction</label>
                <input name="end_extract" type="date" />

                <label>End Schedule</label>
                <input name="end_schedule" type="date" />

                <label>Blocks</label>
                <div id="schedule">
                    <select name="schedule" onchange="updateSchedule(this)">
                        <option value="academic">Academic Year</option>
                        <option value="grace">G.R.A.C.E.</option>
                    </select>

                    <div id="academic" class="blocks-grid">
                        <span></span>
                        <span></span>
                        <label>Zoom Room URL</label>

                        <label>Red</label>
                        <input name="blocks[]" type="checkbox" value="RD"/>
                        <input name="zoom_urls[]" type="url" disabled />

                        <label>Orange</label>
                        <input name="blocks[]" type="checkbox" value="OR"/>
                        <input name="zoom_urls[]" type="url" disabled />

                        <label>Yellow</label>
                        <input name="blocks[]" type="checkbox" value="YL"/>
                        <input name="zoom_urls[]" type="url" disabled />

                        <label>Green</label>
                        <input name="blocks[]" type="checkbox" value="GR"/>
                        <input name="zoom_urls[]" type="url" disabled />

                        <label>Light Blue</label>
                        <input name="blocks[]" type="checkbox" value="LB"/>
                        <input name="zoom_urls[]" type="url" disabled />

                        <label>Dark Blue</label>
                        <input name="blocks[]" type="checkbox" value="DB"/>
                        <input name="zoom_urls[]" type="url" disabled />

                        <label>Purple</label>
                        <input name="blocks[]" type="checkbox" value="PR"/>
                        <input name="zoom_urls[]" type="url" disabled />
                    </div>

                    <div id="grace" class="blocks-grid">
                        <span></span>
                        <span></span>
                        <label>Zoom Room URL</label>

                        <label>W</label>
                        <input name="blocks[]" type="checkbox" value="W"/>
                        <input name="zoom_urls[]" type="url" disabled />

                        <label>X</label>
                        <input name="blocks[]" type="checkbox" value="X"/>
                        <input name="zoom_urls[]" type="url" disabled />

                        <label>Y</label>
                        <input name="blocks[]" type="checkbox" value="Y"/>
                        <input name="zoom_urls[]" type="url" disabled />

                        <label>Z</label>
                        <input name="blocks[]" type="checkbox" value="Z"/>
                        <input name="zoom_urls[]" type="url" disabled />
                    </div>
                </div>

                <label>Calendar name</label>
                <input name="calendar_name" type="text" value="Zoom Room Schedule"/>
            </form>
            <div>
                <button type="submit" form="form">Go</button>
                <button id="reset">Reset</button>
            </div>
            <p><strong>How this works.</strong> This generates an ICS calendar file to import into a Zoom Room calendar. Paste in the webcal URL of a faculty member's schedule from the LMS. Check off the blocks for which you would like to include from the faculty calendar and paste in the relevant Zoom meeting URLs for each block. Optionally, give the calendar a meaningful name (&ldquo;Smith, Room 123&rdquo;). Click <em>Go</em> to download the ICS calendar of Zoom meetings.</p>
            <p><a href="https://youtu.be/HzOvhdKELFM" target="_blank">Click here for a video walk-through</a></p>
        </div>
        <script>
            const cookies = document.cookie.split('; ');

            const getCookie = (key, value) =>  cookies.reduce((prev, curr) => {
                    try {
                        const [ignore, result] = curr.match(new RegExp(`^${key}=(.*)$`));
                        if (result) {
                            return result;
                        }
                    } catch (error) {
                        // do nothing
                    }
                    return prev;
                }, value)

            const setCookie = (input, key) => {
                document.cookie = `${encodeURIComponent(key)}=${encodeURIComponent(input.value)}`;
            }

            const trackWithCookie = (key, value) => {
                const input = document.querySelector(`[name="${key}"]`);
                input.value = getCookie(key, value);
                input.addEventListener('change', setCookie.bind(null, input, key));
                return input.value;
            }

            const updateSchedule = (schedule) => {
                if (!schedule) {
                    schedule = document.querySelector('[name="schedule"]');
                }
                Array.from(document.querySelectorAll('.blocks-grid')).forEach(blocksGrid => {
                    if (schedule.value === blocksGrid.id) {
                        blocksGrid.classList.remove('hidden');
                    } else {
                        blocksGrid.classList.add('hidden');
                    }
                });
            }

            const start = new Date(trackWithCookie('start', (new Date()).toLocaleDateString('en-CA')));
            const end_extract = trackWithCookie('end_extract', (new Date(start.getTime() + start.getTimezoneOffset() * 60 * 1000 + 7 * 24 * 60 * 60 * 1000)).toLocaleDateString('en-CA'));
            trackWithCookie('end_schedule', end_extract);
            trackWithCookie('schedule', 'academic');
            updateSchedule();

            document.querySelector('input[name="start"]').addEventListener('change', start => {
                const end = document.querySelector('input[name="end_extract"]');
                if (start.value != '' && end.value == '') {
                    console.log(start.value);
                }
            })

            const toggleZoomUrl = zoomUrl => {
                zoomUrl.disabled = !zoomUrl.disabled;
            }
            Array.from(document.querySelectorAll('input[name="blocks[]"]')).forEach(checkbox => {
                checkbox.addEventListener('click', toggleZoomUrl.bind(null, checkbox.nextElementSibling));
            });

            const zoomUrls = Array.from(document.querySelectorAll('input[name="zoom_urls[]"]'));
            const initialWidth = zoomUrls[0].clientWidth;
            const resizeToFitUrl = (input) => {
                const test = document.createElement('div');
                test.classList.add('test');
                    document.body.appendChild(test);
                let width = initialWidth;
                zoomUrls.forEach(zoomUrl => {
                    test.innerText = zoomUrl.value;
                    width = Math.max(width, test.clientWidth);
                })
                test.remove();
                if (width > initialWidth) {
                    input.parentElement.style.gridTemplateColumns = `auto auto calc(${width}px + 1em)`;
                } else {
                    input.parentElement.style.gridTemplateColumns = 'auto auto 1fr';
                }
            }
            zoomUrls.forEach(zoomUrl => {
                zoomUrl.addEventListener('input', resizeToFitUrl.bind(null, zoomUrl));
            })

            document.querySelector('button#reset').addEventListener('click', () => location.reload());
        </script>
    </body>
</html>
